<template>
  <div class="min-h-screen bg-gray-50">
    <!-- Hero Section -->
    <section class="bg-gradient-to-br from-primary-900 to-primary-800 text-white py-12 md:py-16">
      <div class="container text-center">
        <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold mb-4">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π —Ç–∞—Ä–∏—Ñ</h1>
        <p class="text-lg md:text-xl opacity-90 max-w-2xl mx-auto">
          –í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –æ—Ç–º–µ—Ç–∫–∏ –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –ø–∞–∫–µ—Ç–∞ –æ–±—É—á–µ–Ω–∏—è
        </p>
      </div>
    </section>

    <div class="container py-8 md:py-12">
      <div class="grid lg:grid-cols-3 gap-8">
        <!-- Left Column: Selection Options -->
        <div class="lg:col-span-2 space-y-8">
          <!-- Selected Items Display -->
          <div v-if="selectedItems.length > 0" class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h3 class="text-lg font-bold text-gray-900 mb-4">–í—ã–±—Ä–∞–Ω–æ: {{ selectedItems.length }}</h3>
            <div class="flex flex-wrap gap-2">
              <span
                v-for="item in selectedItems"
                :key="item.id"
                class="inline-flex items-center gap-2 bg-primary-100 text-primary-800 px-3 py-1.5 rounded-full text-sm font-medium"
              >
                {{ item.name }}
                <button @click="toggleItem(item)" class="hover:text-primary-600">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                </button>
              </span>
            </div>
          </div>

          <!-- Categories Section -->
          <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h2 class="text-xl font-bold text-gray-900 mb-2">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç—Ä–∞–∫—Ç–æ—Ä–∏—Å—Ç–∞-–º–∞—à–∏–Ω–∏—Å—Ç–∞</h2>
            <p class="text-gray-600 text-sm mb-6">–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</p>

            <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-7 gap-3">
              <button
                v-for="cat in categories"
                :key="cat.id"
                @click="toggleItem(cat)"
                class="relative px-4 py-3 rounded-xl font-bold text-lg transition-all duration-200 border-2"
                :class="[
                  isSelected(cat)
                    ? 'bg-primary-600 text-white border-primary-600 shadow-lg shadow-primary-200'
                    : 'bg-white text-gray-700 border-gray-200 hover:border-primary-300 hover:bg-primary-50'
                ]"
              >
                {{ cat.name }}
                <span v-if="isSelected(cat)" class="absolute -top-1 -right-1 w-5 h-5 bg-emerald-500 rounded-full flex items-center justify-center">
                  <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                </span>
              </button>
            </div>
          </div>

          <!-- Marks/Endorsements Section -->
          <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h2 class="text-xl font-bold text-gray-900 mb-2">–û—Ç–º–µ—Ç–∫–∏ (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏)</h2>
            <p class="text-gray-600 text-sm mb-6">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏</p>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
              <button
                v-for="mark in marks"
                :key="mark.id"
                @click="toggleItem(mark)"
                class="relative flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 border-2 text-left"
                :class="[
                  isSelected(mark)
                    ? 'bg-primary-600 text-white border-primary-600 shadow-lg shadow-primary-200'
                    : 'bg-white text-gray-700 border-gray-200 hover:border-primary-300 hover:bg-primary-50',
                  mark.id === freeGiftId ? 'ring-2 ring-emerald-400 ring-offset-2' : ''
                ]"
              >
                <span class="text-2xl">{{ mark.icon }}</span>
                <span class="font-medium text-sm">{{ mark.name }}</span>
                <span v-if="isSelected(mark)" class="absolute -top-1 -right-1 w-5 h-5 bg-emerald-500 rounded-full flex items-center justify-center">
                  <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                </span>
                <span v-if="mark.id === freeGiftId" class="absolute -top-2 -left-2 bg-emerald-500 text-white text-xs px-2 py-0.5 rounded-full font-bold">
                  –ü–æ–¥–∞—Ä–æ–∫!
                </span>
              </button>
            </div>
          </div>

          <!-- Existing License Toggle -->
          <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <label class="flex items-center gap-4 cursor-pointer">
              <div class="relative">
                <input
                  type="checkbox"
                  v-model="hasExistingLicense"
                  class="sr-only peer"
                />
                <div class="w-14 h-8 bg-gray-200 rounded-full peer peer-checked:bg-primary-600 transition-colors"></div>
                <div class="absolute left-1 top-1 w-6 h-6 bg-white rounded-full shadow transition-transform peer-checked:translate-x-6"></div>
              </div>
              <div>
                <p class="font-bold text-gray-900">–£ –º–µ–Ω—è –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –†–§ –∏–ª–∏ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ —Ç—Ä–∞–∫—Ç–æ—Ä–∏—Å—Ç–∞</p>
                <p class="text-sm text-gray-500">–¢–µ–æ—Ä–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è ‚Äî —Å–∫–∏–¥–∫–∞ 5 000 ‚ÇΩ</p>
              </div>
            </label>
          </div>
        </div>

        <!-- Right Column: Price Summary -->
        <div class="lg:col-span-1">
          <div class="sticky top-4 space-y-6">
            <!-- Price Card -->
            <div class="bg-white rounded-2xl p-6 shadow-lg border border-gray-100">
              <h3 class="text-lg font-bold text-gray-900 mb-4">–í–∞—à —Ç–∞—Ä–∏—Ñ</h3>

              <!-- Empty State -->
              <div v-if="selectedItems.length === 0" class="text-center py-8">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                  </svg>
                </div>
                <p class="text-gray-500">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–ª–∏ –æ—Ç–º–µ—Ç–∫–∏</p>
              </div>

              <!-- Price Breakdown -->
              <div v-else class="space-y-4">
                <!-- Selected Items List -->
                <div class="space-y-2 pb-4 border-b border-gray-100">
                  <div
                    v-for="item in selectedItems"
                    :key="item.id"
                    class="flex justify-between items-center text-sm"
                  >
                    <span class="text-gray-600">{{ item.name }}</span>
                    <span class="font-medium" :class="item.id === freeGiftId ? 'text-emerald-600' : 'text-gray-900'">
                      {{ item.id === freeGiftId ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : formatPrice(getItemPrice(item)) }}
                    </span>
                  </div>
                </div>

                <!-- Theory Fee -->
                <div class="flex justify-between items-center text-sm pb-4 border-b border-gray-100">
                  <span class="text-gray-600">–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–±—É—á–µ–Ω–∏–µ</span>
                  <span class="font-medium" :class="hasExistingLicense ? 'text-emerald-600 line-through' : 'text-gray-900'">
                    {{ hasExistingLicense ? '0 ‚ÇΩ' : '5 000 ‚ÇΩ' }}
                  </span>
                </div>

                <!-- Gift Notification -->
                <div v-if="canGetGift && !freeGiftId" class="bg-emerald-50 border border-emerald-200 rounded-xl p-4">
                  <div class="flex items-start gap-3">
                    <span class="text-2xl">üéÅ</span>
                    <div>
                      <p class="font-bold text-emerald-800 text-sm">–ü–æ–¥–∞—Ä–æ–∫ –¥–æ—Å—Ç—É–ø–µ–Ω!</p>
                      <p class="text-emerald-700 text-xs">–í—ã–±–µ—Ä–∏—Ç–µ –µ—â—ë –æ–¥–Ω—É –æ—Ç–º–µ—Ç–∫—É ‚Äî –æ–Ω–∞ –±—É–¥–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π</p>
                    </div>
                  </div>
                </div>

                <!-- Discount Info -->
                <div v-if="discount > 0" class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                  <div class="flex items-start gap-3">
                    <span class="text-2xl">üí∞</span>
                    <div>
                      <p class="font-bold text-amber-800 text-sm">–°–∫–∏–¥–∫–∞ –∑–∞ –æ–±—ä—ë–º!</p>
                      <p class="text-amber-700 text-xs">–í—ã —ç–∫–æ–Ω–æ–º–∏—Ç–µ {{ formatPrice(discount) }}</p>
                    </div>
                  </div>
                </div>

                <!-- Total Price -->
                <div class="pt-4">
                  <div class="flex justify-between items-center">
                    <span class="text-gray-600">–ò—Ç–æ–≥–æ:</span>
                    <div class="text-right">
                      <span v-if="originalPrice > totalPrice" class="text-gray-400 line-through text-sm block">
                        {{ formatPrice(originalPrice) }}
                      </span>
                      <span class="text-2xl font-bold text-primary-600">{{ formatPrice(totalPrice) }}</span>
                    </div>
                  </div>
                </div>

                <!-- CTA Button -->
                <button
                  @click="submitApplication"
                  class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-4 px-6 rounded-xl transition-colors shadow-lg shadow-emerald-200"
                >
                  –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞—è–≤–∫—É
                </button>

                <p class="text-xs text-gray-500 text-center">
                  –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π
                </p>
              </div>
            </div>

            <!-- Pricing Info -->
            <div class="bg-primary-50 rounded-2xl p-6 border border-primary-100">
              <h4 class="font-bold text-primary-900 mb-3">–ö–∞–∫ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è —Ü–µ–Ω–∞</h4>
              <ul class="space-y-2 text-sm text-primary-800">
                <li class="flex items-start gap-2">
                  <span class="text-primary-500 mt-0.5">‚Ä¢</span>
                  <span>1-2 –ø–æ–∑–∏—Ü–∏–∏: 10 000 ‚ÇΩ –∑–∞ –∫–∞–∂–¥—É—é</span>
                </li>
                <li class="flex items-start gap-2">
                  <span class="text-primary-500 mt-0.5">‚Ä¢</span>
                  <span>3-5 –ø–æ–∑–∏—Ü–∏–π: 8 000 ‚ÇΩ –∑–∞ –∫–∞–∂–¥—É—é</span>
                </li>
                <li class="flex items-start gap-2">
                  <span class="text-primary-500 mt-0.5">‚Ä¢</span>
                  <span>6+ –ø–æ–∑–∏—Ü–∏–π: 6 000 ‚ÇΩ –∑–∞ –∫–∞–∂–¥—É—é</span>
                </li>
                <li class="flex items-start gap-2">
                  <span class="text-emerald-500 mt-0.5">‚òÖ</span>
                  <span>8+ –ø–æ–∑–∏—Ü–∏–π: –æ–¥–Ω–∞ –æ—Ç–º–µ—Ç–∫–∞ –≤ –ø–æ–¥–∞—Ä–æ–∫!</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'

interface SelectableItem {
  id: string
  name: string
  type: 'category' | 'mark'
  icon?: string
  extraCost?: number
}

// Categories
const categories: SelectableItem[] = [
  { id: 'cat-b', name: 'B', type: 'category' },
  { id: 'cat-c', name: 'C', type: 'category' },
  { id: 'cat-d', name: 'D', type: 'category' },
  { id: 'cat-e', name: 'E', type: 'category' },
  { id: 'cat-f', name: 'F', type: 'category' },
  { id: 'cat-a1', name: 'A I', type: 'category' },
  { id: 'cat-a2', name: 'A II', type: 'category', extraCost: 1000 },
]

// Marks/Endorsements
const marks: SelectableItem[] = [
  { id: 'mark-loader', name: '–í–æ–¥–∏—Ç–µ–ª—å –ø–æ–≥—Ä—É–∑—á–∏–∫–∞', type: 'mark', icon: 'üöú' },
  { id: 'mark-excavator', name: '–ú–∞—à–∏–Ω–∏—Å—Ç —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä–∞', type: 'mark', icon: 'üèóÔ∏è' },
  { id: 'mark-grader', name: '–ú–∞—à–∏–Ω–∏—Å—Ç –∞–≤—Ç–æ–≥—Ä–µ–π–¥–µ—Ä–∞', type: 'mark', icon: 'üõ§Ô∏è' },
  { id: 'mark-bulldozer', name: '–ú–∞—à–∏–Ω–∏—Å—Ç –±—É–ª—å–¥–æ–∑–µ—Ä–∞', type: 'mark', icon: 'üöß' },
  { id: 'mark-milling', name: '–ú–∞—à–∏–Ω–∏—Å—Ç —Ñ—Ä–µ–∑—ã –¥–æ—Ä–æ–∂–Ω–æ–π', type: 'mark', icon: '‚öôÔ∏è' },
  { id: 'mark-drilling', name: '–ú–∞—à–∏–Ω–∏—Å—Ç –±—É—Ä–æ–≤–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏', type: 'mark', icon: 'üî©' },
  { id: 'mark-skidder', name: '–ú–∞—à–∏–Ω–∏—Å—Ç —Ç—Ä–µ–ª—ë–≤–æ—á–Ω–æ–π –º–∞—à–∏–Ω—ã', type: 'mark', icon: 'üå≤' },
  { id: 'mark-piledriver', name: '–ú–∞—à–∏–Ω–∏—Å—Ç –∫–æ–ø—Ä–∞', type: 'mark', icon: 'üî®' },
  { id: 'mark-reloader', name: '–ú–∞—à–∏–Ω–∏—Å—Ç –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç–µ–ª—è', type: 'mark', icon: 'üì¶' },
  { id: 'mark-roller', name: '–ú–∞—à–∏–Ω–∏—Å—Ç –∫–∞—Ç–∫–∞', type: 'mark', icon: 'üõû' },
  { id: 'mark-crane', name: '–ú–∞—à–∏–Ω–∏—Å—Ç –∫—Ä–∞–Ω–∞', type: 'mark', icon: 'üèóÔ∏è' },
]

const selectedIds = ref<Set<string>>(new Set())
const hasExistingLicense = ref(false)
const freeGiftId = ref<string | null>(null)

const selectedItems = computed(() => {
  const allItems = [...categories, ...marks]
  return allItems.filter(item => selectedIds.value.has(item.id))
})

const selectedCount = computed(() => selectedIds.value.size)

const canGetGift = computed(() => {
  // Can get gift if 8+ items selected and at least one category
  const hasCategory = selectedItems.value.some(item => item.type === 'category')
  return selectedCount.value >= 8 && hasCategory
})

const isSelected = (item: SelectableItem) => selectedIds.value.has(item.id)

const toggleItem = (item: SelectableItem) => {
  const newSet = new Set(selectedIds.value)

  if (newSet.has(item.id)) {
    newSet.delete(item.id)
    // If removing the free gift, clear it
    if (freeGiftId.value === item.id) {
      freeGiftId.value = null
    }
  } else {
    // Check if this should be a free gift
    if (canGetGift.value && !freeGiftId.value && item.type === 'mark') {
      freeGiftId.value = item.id
    }
    newSet.add(item.id)
  }

  selectedIds.value = newSet

  // Recalculate free gift eligibility
  if (!canGetGift.value) {
    freeGiftId.value = null
  }
}

const getBasePrice = (count: number): number => {
  if (count <= 2) return 10000
  if (count <= 5) return 8000
  return 6000
}

const getItemPrice = (item: SelectableItem): number => {
  const basePrice = getBasePrice(selectedCount.value)
  return basePrice + (item.extraCost || 0)
}

const originalPrice = computed(() => {
  // Calculate price as if each item was 10000 (no volume discount)
  let total = selectedItems.value.reduce((sum, item) => {
    return sum + 10000 + (item.extraCost || 0)
  }, 0)

  // Add theory fee
  if (!hasExistingLicense.value) {
    total += 5000
  }

  return total
})

const totalPrice = computed(() => {
  const count = selectedCount.value
  if (count === 0) return 0

  let total = 0

  selectedItems.value.forEach(item => {
    // Skip free gift
    if (item.id === freeGiftId.value) return
    total += getItemPrice(item)
  })

  // Add theory fee if no existing license
  if (!hasExistingLicense.value && count > 0) {
    total += 5000
  }

  return total
})

const discount = computed(() => {
  return originalPrice.value - totalPrice.value
})

const formatPrice = (price: number): string => {
  return price.toLocaleString('ru-RU') + ' ‚ÇΩ'
}

const submitApplication = () => {
  // Could integrate with a modal or form submission
  alert('–ó–∞—è–≤–∫–∞ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.')
}

// SEO
useHead({
  title: '–°–æ–∑–¥–∞—Ç—å —Å–≤–æ–π —Ç–∞—Ä–∏—Ñ - –¢—Ä–∞–∫—Ç–æ—Ä–Ω—ã–µ –ü—Ä–∞–≤–∞ –†–§',
  meta: [
    {
      name: 'description',
      content: '–°–æ–∑–¥–∞–π—Ç–µ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π —Ç–∞—Ä–∏—Ñ –Ω–∞ –æ–±—É—á–µ–Ω–∏–µ. –í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –æ—Ç–º–µ—Ç–∫–∏ —Ç—Ä–∞–∫—Ç–æ—Ä–∏—Å—Ç–∞-–º–∞—à–∏–Ω–∏—Å—Ç–∞.'
    }
  ]
})
</script>

<style scoped>
/* Custom checkbox toggle styles */
input:checked + div {
  @apply bg-primary-600;
}

input:checked + div + div {
  @apply translate-x-6;
}
</style>
